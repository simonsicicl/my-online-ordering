name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
      
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Lint
        run: pnpm lint
      
      - name: Build
        run: pnpm build
      
      - name: Test
        run: pnpm test

  # Auto-deploy Lambda functions to Staging when develop branch is pushed
  deploy-lambda-staging:
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: lint-and-test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      
      - name: Deploy all Lambda functions
        run: |
          # Loop through all Lambda directories
          for dir in lambdas/*/; do
            if [ -f "$dir/index.mjs" ]; then
              echo "====================================="
              echo "Deploying $(basename $dir)..."
              echo "====================================="
              cd "$dir"
              
              # Install production dependencies
              npm install --production
              
              # Create deployment package
              zip -r function.zip node_modules index.mjs package.json
              
              # Get function name from directory
              function_name="myordering-$(basename $dir)"
              
              # Deploy to AWS Lambda
              aws lambda update-function-code \
                --function-name "$function_name" \
                --zip-file fileb://function.zip \
                --region us-west-2 || echo "Function $function_name may not exist yet, skipping..."
              
              # Wait for update to complete
              aws lambda wait function-updated \
                --function-name "$function_name" \
                --region us-west-2 2>/dev/null || true
              
              echo "‚úÖ $function_name deployed"
              cd ../..
            fi
          done
      
      - name: Run smoke tests
        run: |
          echo "====================================="
          echo "Running Lambda smoke tests..."
          echo "====================================="
          
          # Test each deployed Lambda function
          for dir in lambdas/*/; do
            if [ -f "$dir/index.mjs" ]; then
              function_name="myordering-$(basename $dir)"
              
              echo "Testing $function_name..."
              aws lambda invoke \
                --function-name "$function_name" \
                --region us-west-2 \
                --log-type Tail \
                response.json 2>/dev/null || echo "‚ö†Ô∏è Function $function_name not found or failed"
              
              # Check if response exists and has statusCode 200
              if [ -f response.json ]; then
                if grep -q '"statusCode": 200' response.json 2>/dev/null || grep -q '"success": true' response.json 2>/dev/null; then
                  echo "‚úÖ $function_name test passed"
                else
                  echo "‚ö†Ô∏è $function_name may have issues (check CloudWatch logs)"
                fi
                rm response.json
              fi
            fi
          done
          
          echo "====================================="
          echo "Smoke tests completed"
          echo "====================================="

  # Auto-deploy to Production when main branch is pushed
  deploy-lambda-production:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: lint-and-test
    runs-on: ubuntu-latest
    # Environment protection disabled for single-person development
    # Uncomment below if team grows and needs manual approval for production
    # environment:
    #   name: production
    #   url: https://myordering.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Configure AWS credentials (Production)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: us-west-2
      
      - name: Deploy all Lambda functions to Production
        run: |
          # Loop through all Lambda directories
          for dir in lambdas/*/; do
            if [ -f "$dir/index.mjs" ]; then
              echo "====================================="
              echo "Deploying $(basename $dir) to PRODUCTION..."
              echo "====================================="
              cd "$dir"
              
              # Install production dependencies
              npm install --production
              
              # Create deployment package
              zip -r function.zip node_modules index.mjs package.json
              
              # Get production function name
              function_name="myordering-$(basename $dir)-prod"
              
              # Deploy to AWS Lambda (Production)
              aws lambda update-function-code \
                --function-name "$function_name" \
                --zip-file fileb://function.zip \
                --region us-west-2
              
              # Wait for update to complete
              aws lambda wait function-updated \
                --function-name "$function_name" \
                --region us-west-2
              
              echo "‚úÖ $function_name deployed to production"
              cd ../..
            fi
          done
      
      - name: Run production smoke tests
        run: |
          echo "====================================="
          echo "Running production smoke tests..."
          echo "====================================="
          
          # Test each Lambda function
          for dir in lambdas/*/; do
            if [ -f "$dir/index.mjs" ]; then
              function_name="myordering-$(basename $dir)-prod"
              
              echo "Testing $function_name..."
              aws lambda invoke \
                --function-name "$function_name" \
                --region us-west-2 \
                --log-type Tail \
                response.json
              
              if grep -q '"statusCode": 200' response.json 2>/dev/null || grep -q '"success": true' response.json 2>/dev/null; then
                echo "‚úÖ $function_name test passed"
              else
                echo "‚ùå $function_name test FAILED"
                cat response.json
                exit 1
              fi
              rm response.json
            fi
          done
          
          echo "====================================="
          echo "Production smoke tests completed"
          echo "====================================="
      
      - name: Notify deployment success
        run: |
          echo "====================================="
          echo "üéâ Production deployment successful!"
          echo "====================================="
          # TODO: Add Slack/Discord/Email notification in future